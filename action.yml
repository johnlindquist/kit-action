name: "Script Kit Action"
description: "Uses @johnlindquist/kit to run a script"
author: "John Lindquist"
inputs:
  script:
    required: true
    description: "name of a script in your ./scripts dir"
  args:
    required: false
    description: "args to pass to the script"
outputs:
  result:
    description: "result of the script args"
    value: ${{ steps.script-kit.outputs.result }}

runs:
  using: "composite"
  steps:
    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v4

    - uses: actions/checkout@v3 # Checkout this project (including ./scripts dir)

    - name: Add node and ./kit/bin to PATH
      run: |
        echo "$HOME/.kit/node/bin" >> $GITHUB_PATH
      shell: bash

    - name: Script Kit running ${{ inputs.script }}
      id: script-kit
      run: |
        # Get name of the current step
        job_name=$(echo $GITHUB_JOB | sed 's/ /-/g')
        echo "job_name: $job_name"

        # Get the name of the current workflow
        workflow_name=$(echo $GITHUB_WORKFLOW | sed 's/ /-/g')
        echo "workflow_name: $workflow_name"

        # Get the name of the step that called this action
        step_name=$(echo $GITHUB_ACTION | sed 's/ /-/g')
        echo "step_name: $step_name"

        # Get the name of the action from the id
        action_name=$(echo ${{ github.action }} | sed 's/ /-/g')
        echo "action_name: $action_name"

        echo "action_path: ${{ github.action_path }}"

        kit_dir="$HOME/.kit"
        node_dir="$HOME/.knode"

        kit_node="$node_dir/bin/node"
        kit_npm="$node_dir/bin/npm"

        export KIT_NODE="$kit_node"        
        export KIT="$kit_dir/node_modules/@johnlindquist/kit"  

        mkdir -p $node_dir
        mkdir -p $kit_dir

        [ ! -d "$node_dir/bin" ] && curl -sfLS https://install-node.vercel.app/v16.14.2 | bash -s -- -f --prefix $node_dir
        $kit_npm i --prefix $kit_dir @johnlindquist/kit
        $kit_npm i --prefix $kit_dir @actions/github
        $kit_node --version

        export KENV="$HOME/work/${{ env.GITHUB_REPOSITORY_NAME_PART }}/${{ env.GITHUB_REPOSITORY_NAME_PART }}"
        cd $KENV
        $kit_npm init es6 -y
        $kit_npm i -D @johnlindquist/kit

        echo "üèÉ‚Äç‚ôÄÔ∏è Running ${{ inputs.script}} with ${{ inputs.args }}"

        $kit_node $KIT/run/github-workflow.js "${{ inputs.script }}" "${{ inputs.args }}" --trust
      shell: bash

    # - name: Check Result for Error
    #   uses: actions/github-script@v6
    #   with:
    #     script: |
    #       console.log('Testing...')
    #       if(${{ contains(steps.script-kit.outputs.result, 'Error') }}){
    #         console.log(${{ toJSON(steps.script-kit.outputs.result) }})
    #       }else{
    #         console.log(`No 'Error' detected...`)
    #       }
# if(`${{ steps.script-kit.outputs.result }}`.includes('Error')){
#   console.log(`üò¢ Failed due to Error in result string`)
#   core.setFailed('${{ steps.test-get.outputs.result }}')
# }
#     - name: Setup tmate session
#       uses: mxschmitt/action-tmate@v3
