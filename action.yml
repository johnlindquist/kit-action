name: "Script Kit Action"
description: "Uses @johnlindquist/kit to run a script"
author: "John Lindquist"
inputs:
  script:
    required: true
    description: "name of a script in your ./scripts dir"
  args:
    required: false
    description: "args to pass to the script"
outputs:
  result:
    description: "result of the script args"
    value: ${{ steps.script-kit.outputs.result }}

runs:
  using: "composite"
  steps:
    - name: Inject slug/short variables
      uses: rlespinasse/github-slug-action@v3.x

    - uses: actions/checkout@v2 # Checkout this project (including ./scripts dir)

    - name: Script Kit Config
      run: |
        export node_dir="$HOME/node"
        export kit_dir="$HOME/kit"

        export node_bin="$node_dir/bin"
        export kit_node="$node_bin/node"
        export kit_npm="$node_bin/npm"
        echo "$node_bin" >> $GITHUB_PATH


        export KIT_NODE="$kit_node"        
        export KIT="$kit_dir/node_modules/@johnlindquist/kit"  

        mkdir -p $node_dir
        mkdir -p $kit_dir

        [ ! -d "$node_dir/bin" ] && curl -sfLS https://install-node.vercel.app/v16.9.1 | bash -s -- -f --prefix $node_dir

        [ ! -d "$kit_dir/node_modules/@johnlindquist/kit" ] && $kit_npm i --prefix $kit_dir @johnlindquist/kit@alpha

        echo $PATH
        node --version

        # find . | sed -e "s/[^-][^\/]*\//  |/g" -e "s/|\([^ ]\)/|-\1/" 

        project_dir="$HOME/work/${{ env.GITHUB_REPOSITORY_NAME_PART }}/${{ env.GITHUB_REPOSITORY_NAME_PART }}"

        # echo "ðŸ‘€ PROJECT DIR: $project_dir"
      shell: bash

    - name: Script Kit running ${{ inputs.script }}
      id: script-kit
      run: |
        cd $project_dir

        # find $project_dir | sed -e "s/[^-][^\/]*\//  |/g" -e "s/|\([^ ]\)/|-\1/" 

        result=$($KIT/bin/k "${{ inputs.script }}" "${{ inputs.args }}")
        echo "::set-output name=result::$result"
      shell: bash

    # - name: Setup tmate session
    #   uses: mxschmitt/action-tmate@v3
